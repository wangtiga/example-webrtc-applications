<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>sfu</title>

<style type="text/css">
.comments {
 width:100%;/*auto width*/
 overflow:auto;
 word-break:break-all;
}
</style>
</head>

<body>

<div>

	<ul>
		<li>
			<video id="video1" width="320" height="240" autoplay muted controls></video> <br />

			<button class="sessbtn" onclick="window.createSession(true)">Publish</button>
			<button class="sessbtn" onclick="window.createSession(false)">Subscribe</button>

			<div id="signalingContainer" style="display: none">
			    Client SDP<textarea class="comments" id="localSDP" readonly="true" rows=10   cols=30   onpropertychange= "this.style.posHeight=this.scrollHeight "></textarea>
			    Server SDP<textarea class="comments" id="remoteSDP" readonly="true" rows=10   cols=30   onpropertychange= "this.style.posHeight=this.scrollHeight "></textarea>
			</div>
		<li>
	</ul>

</div>
<div id="logs"></div>


<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

<script>
var log = msg => {
    document.getElementById("logs").innerHTML += msg + "<br>"
}

var uiSignalingContainer = document.getElementById("signalingContainer");
var uiRemoteSDP = document.getElementById("remoteSDP");
var uiLocalSDP  = document.getElementById("localSDP");
var uiVideo     = document.getElementById("video1");

var sock = null;
var wsuri = "wss://" + location.host + "/ws";

window.onload = function() {
    sock = new WebSocket(wsuri);
    sock.onopen = function() {
        console.log("websocket connected to " + wsuri);
    }
    sock.onclose = function(e) {
        console.log("websocket connection closed (" + e.code + ")");
    }
    sock.onmessage = function(e) {
	let sdp = e.data;
        console.log("websocket message received: " + sdp);
        uiRemoteSDP.value = sdp;
        window.startSession(sdp);
    }
    sock.onerror = function(e) {
        console.log("websocket error: " + e.data)
    }
};

window.createSession = isPublisher => {
    let pc = new RTCPeerConnection({
        iceServers: [
            {
                //urls: "stun:stun.l.google.com:19302"
                urls: "stun:turn.tiga.wang:3478",
                username: "com",
                credential: "webrtcdemo"
            }
        ]
    });

    pc.oniceconnectionstatechange = e => log(pc.iceConnectionState);
    pc.onicecandidate = event => {
        if (event.candidate !== null) {
            return;
        }
        uiLocalSDP.value = pc.localDescription.sdp;
        sock.send(pc.localDescription.sdp);
        console.log("send sdp to server:==============\n" + pc.localDescription.sdp); 
    }

    if (isPublisher) {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true})
            .then(stream => {
                pc.addStream(uiVideo.srcObject = stream)
                pc.createOffer()
                  .then(d => pc.setLocalDescription(d))
                  .catch(log)
            }).catch(log);
            console.log("Publisher createOffer");
    } else {
        console.log("Subcriber createOffer");
        pc.addTransceiver("audio", {"direction": "recvonly"});
        pc.addTransceiver("video", {"direction": "recvonly"});

        //pc.addTransceiver("audio", {"direction": "sendrecv"})
        //pc.addTransceiver("video", {"direction": "sendrecv"})

        pc.createOffer()
            .then(d => pc.setLocalDescription(d))
            .catch(log);

        console.log("Subcriber ontrack");
        pc.ontrack = function (event) {
            var el = uiVideo;
            el.srcObject = event.streams[0];
            el.autoplay = true;
            el.controls = true;
        }
    }

    window.startSession = (sdp) => {
        if (sdp === "") {
            return alert("Session Description must not be empty");
        }
        console.log("startSession");

        try {
            pc.setRemoteDescription(new RTCSessionDescription({type:"answer", sdp:sdp}));
        } catch (e) {
            alert(e);
        }
    }

    let btns = document.getElementsByClassName("sessbtn");
    for (let i = 0; i < btns.length; i++) {
        btns[i].style = "display: none";
    }
    uiSignalingContainer.style = "display: block";

}
</script>

</body>

</html>
