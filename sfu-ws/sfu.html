<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>sfu</title>

<style type="text/css">
.comments {
 width:100%;/*auto width*/
 overflow:auto;
 word-break:break-all;
}
</style>
</head>

<body>

<div>

	<ul id="videoAreaList">
		<li id="memberSelf">
			<video class="videoShow" width="320" height="240" autoplay muted controls></video> <br />

			<button class="sessbtn" onclick="window.createSession(this, true)">Publish</button>
			<button class="sessbtn" onclick="window.createSession(this, false)">Subscribe</button>

			<div class="signalingContainer" style="display: none">
			    Client SDP<textarea class="comments localSDP"  readonly="true" rows=10   cols=30   onpropertychange= "this.style.posHeight=this.scrollHeight "></textarea>
			    Server SDP<textarea class="comments remoteSDP" readonly="true" rows=10   cols=30   onpropertychange= "this.style.posHeight=this.scrollHeight "></textarea>
			</div>
		<li>
	</ul>

	<button onclick="window.test1()">test</button>
</div>

<div id="logs"></div>


<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

<script>
var log = msg => {
    document.getElementById("logs").innerHTML += msg + "<br>"
}

var sock = null;
var wsuri = "wss://" + location.host + "/ws";
var msMap = new Map();
//var msPublish = new MediaChannel();
// TODO 1.destroy peerConnection.close();
// TODO 2.js map
// TODO 3.sfu request format
// TODO 3.windows load

window.onload = function() {
    sock.onopen = function() {
        console.log("websocket connected to " + wsuri);
    }
    sock.onclose = function(e) {
        console.log("websocket connection closed (" + e.code + ")");
    }
    sock.onmessage = function(e) {
	let sdp = e.data.sdp;
	let uiID = e.data.memberId;
        //console.log("websocket message received: " + sdp);
        let msMedia = msMap.get(uiID);
	msMedia.SetRemoteSdp(sdp);
    }
    sock.onerror = function(e) {
        console.log("websocket error: " + e.data)
    }
};

window.test1 = arg => {
    let member1 = document.getElementById("memberSelf");
    let cln = member1.cloneNode(true);
    cln.setAttribute("id", "memberTest");

    let videoAreaList = document.getElementById("videoAreaList");
    videoAreaList.appendChild(cln);
}

window.createSession = (uiSelf, isPublisher) => {
    let uiMember = uiSelf.parentElement;
    let uiID = uiMember.getAttribute("id");
    let msPublish  = msMap.get(uuID);

    if (msPublish === undefined) {
        msPublish = new MediaChannel(uiMember, uiID);
	msMap.set(uiID, msPublish);
    }

    sock = new WebSocket(wsuri);
    let uiShow = msPublish.GetElementVideoShow();
    msPublish.CreateSession(isPublisher, uiShow);
}

function MediaChannel(uiMemberItem, memberId) {
    this._uiSignalingContainer = uiMemberItem.getElementsByClassName("signalingContainer")[0];
    this._uiRemoteSDP = uiMemberItem.getElementsByClassName("remoteSDP")[0];
    this._uiLocalSDP  = uiMemberItem.getElementsByClassName("localSDP")[0];
    this._uiShow      = uiMemberItem.getElementsByClassName("videoShow")[0];
    //console.log(this._uiLocalSDP);
    this._memberId = memberId;
}

MediaChannel.prototype.GetElementVideoShow = function () {
    return this._uiShow;
}

MediaChannel.prototype.ShowDebugSDP = function (isPublisher, uiVideo) {
    this._uiSignalingContainer.style = "display: block";
    let btns = this._uiSignalingContainer.getElementsByClassName("sessbtn");
    for (let i = 0; i < btns.length; i++) {
        btns[i].style = "display: none";
    }
}

MediaChannel.prototype.CreateSession = function (isPublisher, uiVideo) {
    let pc = new RTCPeerConnection({
        iceServers: [
            {
                //urls: "stun:stun.l.google.com:19302"
                urls: "stun:turn.tiga.wang:3478",
                username: "com",
                credential: "webrtcdemo"
            }
        ]
    });

    pc.oniceconnectionstatechange = e => log(pc.iceConnectionState);
    pc.onicecandidate = event => {
        if (event.candidate !== null) {
            return;
        }
        this._uiLocalSDP.value = pc.localDescription.sdp;
	let sdp = pc.localDescription.sdp;
	let msg = {"memberId": _memberId , "sdp":sdp};
        sock.send(msg);
        //console.log("send sdp to server:==============\n" + msg); 
    }

    if (isPublisher) {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true})
            .then(stream => {
                pc.addStream(uiVideo.srcObject = stream)
                pc.createOffer()
                  .then(d => pc.setLocalDescription(d))
                  .catch(log)
            }).catch(log);
            console.log("Publisher createOffer");
    } else {
        console.log("Subcriber createOffer");
        pc.addTransceiver("audio", {"direction": "recvonly"});
        pc.addTransceiver("video", {"direction": "recvonly"});

        pc.createOffer()
            .then(d => pc.setLocalDescription(d))
            .catch(log);

        console.log("Subcriber ontrack");
        pc.ontrack = function (event) {
            uiVideo.srcObject = event.streams[0];
            uiVideo.autoplay = true;
            uiVideo.controls = true;
        }
    }


    this.ShowDebugSDP();
    this._pc = pc;
}

MediaChannel.prototype.SetRemoteSdp = function (sdp) {
    if (sdp === "") {
        console.log("Session Description must not be empty");
        return; 
    }
    console.log("startSession sdp");

    try {
        this._pc.setRemoteDescription(new RTCSessionDescription({type:"answer", sdp:sdp}));
        this._uiRemoteSDP.value = sdp;
    } catch (e) {
        console.log("setRemoteDescriptionFail ", e);
    }
}

</script>

</body>

</html>
